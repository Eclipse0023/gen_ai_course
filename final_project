{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "4d082739",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-04-08T13:07:09.077133Z",
     "iopub.status.busy": "2025-04-08T13:07:09.076728Z",
     "iopub.status.idle": "2025-04-08T13:07:17.538460Z",
     "shell.execute_reply": "2025-04-08T13:07:17.537110Z"
    },
    "papermill": {
     "duration": 8.468041,
     "end_time": "2025-04-08T13:07:17.540629",
     "exception": false,
     "start_time": "2025-04-08T13:07:09.072588",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m144.7/144.7 kB\u001b[0m \u001b[31m5.1 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\r\n",
      "\u001b[2K   \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m100.9/100.9 kB\u001b[0m \u001b[31m4.8 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\r\n",
      "\u001b[?25h"
     ]
    }
   ],
   "source": [
    "!pip uninstall -qy jupyterlab  # Remove unused packages from Kaggle's base image that conflict\n",
    "!pip install -U -q \"google-genai==1.7.0\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "0819e9b1",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-04-08T13:07:17.547706Z",
     "iopub.status.busy": "2025-04-08T13:07:17.547348Z",
     "iopub.status.idle": "2025-04-08T13:07:18.822252Z",
     "shell.execute_reply": "2025-04-08T13:07:18.821243Z"
    },
    "papermill": {
     "duration": 1.280841,
     "end_time": "2025-04-08T13:07:18.824488",
     "exception": false,
     "start_time": "2025-04-08T13:07:17.543647",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "from google import genai\n",
    "from google.genai import types\n",
    "\n",
    "from IPython.display import HTML, Markdown, display\n",
    "#https://www.kaggle.com/datasets/robbietli/transactions-20250104-test-data-csv"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "5e133596",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-04-08T13:07:18.832592Z",
     "iopub.status.busy": "2025-04-08T13:07:18.832087Z",
     "iopub.status.idle": "2025-04-08T13:07:19.067871Z",
     "shell.execute_reply": "2025-04-08T13:07:19.066746Z"
    },
    "papermill": {
     "duration": 0.241701,
     "end_time": "2025-04-08T13:07:19.070105",
     "exception": false,
     "start_time": "2025-04-08T13:07:18.828404",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "from google.api_core import retry\n",
    "\n",
    "\n",
    "is_retriable = lambda e: (isinstance(e, genai.errors.APIError) and e.code in {429, 503})\n",
    "\n",
    "genai.models.Models.generate_content = retry.Retry(\n",
    "    predicate=is_retriable)(genai.models.Models.generate_content)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "f902c69f",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-04-08T13:07:19.077068Z",
     "iopub.status.busy": "2025-04-08T13:07:19.076510Z",
     "iopub.status.idle": "2025-04-08T13:07:19.289106Z",
     "shell.execute_reply": "2025-04-08T13:07:19.288055Z"
    },
    "papermill": {
     "duration": 0.218244,
     "end_time": "2025-04-08T13:07:19.291135",
     "exception": false,
     "start_time": "2025-04-08T13:07:19.072891",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "from kaggle_secrets import UserSecretsClient\n",
    "\n",
    "GOOGLE_API_KEY = UserSecretsClient().get_secret(\"GOOGLE_API_KEY\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "a9b37bb6",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-04-08T13:07:19.297829Z",
     "iopub.status.busy": "2025-04-08T13:07:19.297484Z",
     "iopub.status.idle": "2025-04-08T13:07:19.742744Z",
     "shell.execute_reply": "2025-04-08T13:07:19.741771Z"
    },
    "papermill": {
     "duration": 0.450832,
     "end_time": "2025-04-08T13:07:19.744709",
     "exception": false,
     "start_time": "2025-04-08T13:07:19.293877",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "client = genai.Client(api_key=GOOGLE_API_KEY)\n",
    "\n",
    "model_config = types.GenerateContentConfig(\n",
    "    temperature=0.1,\n",
    "    top_p=1,\n",
    "    max_output_tokens=5,\n",
    ")\n",
    "\n",
    "def categorise_transaction(description):\n",
    "    few_shot_prompt = f\"\"\"\n",
    "You are an AI assistant specializing in financial transaction categorization.\n",
    "Your task is to analyze the provided transaction description and assign it to the most appropriate category and subcategory from the predefined lists.\n",
    "\n",
    "**Allowed Categories:**\n",
    "[   - Food & Beverages\n",
    "   - Shopping\n",
    "   - Housing\n",
    "   - Transportation\n",
    "   - Vehicle\n",
    "   - Life & Entertainment\n",
    "   - Communication, PC\n",
    "   - Financial expenses\n",
    "   - Investments\n",
    "   - Income\n",
    "]\n",
    "\n",
    "**Allowed Subcategories (grouped by category for context):**\n",
    "[\"Food & Beverages\": [\"Bar, cafe, drink, snacks\", \"Groceries\", \"Restaurant, fast-food\"],\n",
    "   \"Shopping\": [\"Clothes & Footwear\", \"Drug-store, chemist\", \"Electronics, accessories\",\n",
    "                \"Gifts, joy\", \"Health and beauty\", \"Home, garden\", \"Jewels, accessories\",\n",
    "                \"Kids\", \"Leisure time\", \"Pets, animals\", \"Stationery, tools\"],\n",
    "   \"Housing\": [\"Energy, utilities\", \"Maintenance, repairs\", \"Mortgage\", \"Property insurance\",\n",
    "               \"Rent\", \"Services\"],\n",
    "   \"Transportation\": [\"Business trips\", \"Long distance\", \"Public transport\", \"Taxi\"],\n",
    "   \"Vehicle\": [\"Fuel\", \"Leasing\", \"Parking\", \"Rentals\", \"Vehicle insurance\", \"Vehicle maintenance\"],\n",
    "   \"Life & Entertainment\": [\"Active sport, fitness\", \"Alcohol, tobacco\", \"Books, audio, subscriptions\",\n",
    "                            \"Charity, gifts\", \"Culture, sport events\", \"Education, development\",\n",
    "                            \"Health care, doctor\", \"Hobbies\", \"Holiday, trips, hotels\",\n",
    "                            \"Life events\", \"Lottery, gambling\", \"TV, Streaming\", \"Wellness, beauty\"],\n",
    "   \"Communication, PC\": [\"Internet\", \"Postal services\", \"Software, apps, games\", \"Telephony, mobile phone\"],\n",
    "   \"Financial expenses\": [\"Advisory\", \"Charges, Fees\", \"Child Support\", \"Fines\", \"Insurances\",\n",
    "                          \"Loans, interests\", \"Taxes\"],\n",
    "   \"Investments\": [\"Collections\", \"Financial investments\", \"Realty\", \"Savings\", \"Vehicles, chattels\"],\n",
    "   \"Income\": [\"Checks, coupons\", \"Child Support\", \"Dues & grants\", \"Gifts\", \"Interests, dividends\",\n",
    "              \"Lending, renting\", \"Lottery, gambling\", \"Refunds (tax, purchase)\",\n",
    "              \"Rental income\", \"Sale\", \"Wage, invoices\"]\n",
    "   \"Transfer\":[\"Transfer\"]\n",
    "]\n",
    "\n",
    "**Instructions:**\n",
    "[...] Respond ONLY with a JSON object [...]\n",
    "\n",
    "**Examples:**\n",
    "\n",
    "* **Transaction Description:** \"BP Fuel Richmond VIC\"\n",
    "    **Output:** {{\"category\": \"Transportation\", \"subcategory\": \"Fuel\"}}\n",
    "\n",
    "* **Transaction Description:** \"Salary Deposit ACME Corp\"\n",
    "    **Output:** {{\"category\": \"Income\", \"subcategory\": \"Salary\"}}\n",
    "\n",
    "---\n",
    "**Now, categorize the following transaction:**\n",
    "\n",
    "**Description:**\n",
    "\"{description}\"\n",
    "\n",
    "Output\n",
    "\"\"\"\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "3680529e",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-04-08T13:07:19.751467Z",
     "iopub.status.busy": "2025-04-08T13:07:19.751074Z",
     "iopub.status.idle": "2025-04-08T13:07:20.737967Z",
     "shell.execute_reply": "2025-04-08T13:07:20.736702Z"
    },
    "papermill": {
     "duration": 0.993271,
     "end_time": "2025-04-08T13:07:20.740725",
     "exception": false,
     "start_time": "2025-04-08T13:07:19.747454",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Processing batch 1 (0 to 5)\n",
      "Error processing 'Increase account balance by 1.0 AUD': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Amazon Digital': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Bonus interest activated': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Bonus interest activated': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Interest earned': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Sample result - 'Increase account balance by 1.0 AUD': Error, name 'few_shot_prompt' is not defined\n",
      "Processing batch 2 (5 to 10)\n",
      "Error processing 'Bonus interest activated ($72.91)': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Bonus interest activated': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Bonus interest activated': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Bonus interest activated': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Bonus interest activated': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Sample result - 'Bonus interest activated ($72.91)': Error, name 'few_shot_prompt' is not defined\n",
      "Processing batch 3 (10 to 15)\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx8025|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx8577|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Bonus interest activated': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx3965|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1158|xxxxx2470|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Sample result - 'Transfer\\\\nxxxx1085|xxxxx8025|SAV': Error, name 'few_shot_prompt' is not defined\n",
      "Processing batch 4 (15 to 20)\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx0369|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx5814|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1514|': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Bonus interest activated': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Direct Credit Seek Limited Pay - xxxxxxxxxxxxxx0000': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Sample result - 'Transfer\\\\nxxxx1085|xxxxx0369|SAV': Error, name 'few_shot_prompt' is not defined\n",
      "Processing batch 5 (20 to 25)\n",
      "Error processing 'Transfer\\\\nxxxx1514|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1433|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Direct Credit Seek Limited Pay - xxxxxxxxxxxxxx0000': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1514|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1298|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Sample result - 'Transfer\\\\nxxxx1514|||SAV': Error, name 'few_shot_prompt' is not defined\n",
      "Processing batch 6 (25 to 30)\n",
      "Error processing 'Transfer\\\\nxxxx1433|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Internal transfer': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx7143|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Direct Credit SEKE DIV - xxxxxxxx5234': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx9321|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Sample result - 'Transfer\\\\nxxxx1433|||SAV': Error, name 'few_shot_prompt' is not defined\n",
      "Processing batch 7 (30 to 35)\n",
      "Error processing 'Direct Credit Seek Limited Pay - xxxxxxxxxxxxxx0000': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1298|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1433|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1514|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Bonus interest activated': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Sample result - 'Direct Credit Seek Limited Pay - xxxxxxxxxxxxxx0000': Error, name 'few_shot_prompt' is not defined\n",
      "Processing batch 8 (35 to 40)\n",
      "Error processing 'Transfer\\\\nxxxx1433|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1433|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1158|xxxxx6961': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1514|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Direct Credit Seek Limited Pay - xxxxxxxxxxxxxx0000': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Sample result - 'Transfer\\\\nxxxx1433|||SAV': Error, name 'few_shot_prompt' is not defined\n",
      "Processing batch 9 (40 to 45)\n",
      "Error processing 'Direct Credit Seek Limited Pay - xxxxxxxxxxxxxx0000': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1514|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'BPAY Payment to BENDIGO BANK LOANS\\\\nBENDIGO BANK LOANS|342949|xxxxx5928|xxxx2381': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'BPAY Payment to nab cards\\\\nnab cards|1008|xxxxxxxxxxxx8958|xxxx1483': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Direct Credit Seek Limited Pay - xxxxxxxxxxxxxx0000': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Sample result - 'Direct Credit Seek Limited Pay - xxxxxxxxxxxxxx0000': Error, name 'few_shot_prompt' is not defined\n",
      "Processing batch 10 (45 to 50)\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx4409|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx3336': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1298|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1514|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1433|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Sample result - 'Transfer\\\\nxxxx1085|xxxxx4409|SAV': Error, name 'few_shot_prompt' is not defined\n",
      "Processing batch 11 (50 to 55)\n",
      "Error processing 'Direct Credit Seek Limited Pay - xxxxxxxxxxxxxx0000': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx6953|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1298|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1514|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1433|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Sample result - 'Direct Credit Seek Limited Pay - xxxxxxxxxxxxxx0000': Error, name 'few_shot_prompt' is not defined\n",
      "Processing batch 12 (55 to 60)\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx4990|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Direct Credit Seek Limited Pay - xxxxxxxxxxxxxx0000': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx6850|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx2380|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1298|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Sample result - 'Transfer\\\\nxxxx1085|xxxxx4990|SAV': Error, name 'few_shot_prompt' is not defined\n",
      "Processing batch 13 (60 to 65)\n",
      "Error processing 'Transfer\\\\nxxxx1514|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1433|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx4430|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx7460|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Direct Credit Seek Limited Pay - xxxxxxxxxxxxxx0000': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Sample result - 'Transfer\\\\nxxxx1514|||SAV': Error, name 'few_shot_prompt' is not defined\n",
      "Processing batch 14 (65 to 70)\n",
      "Error processing 'Transfer\\\\nxxxx1514|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1433|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx2482|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Direct Credit MCARE BENEFITS - xxxxx8268 CYWQ': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx7642|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Sample result - 'Transfer\\\\nxxxx1514|||SAV': Error, name 'few_shot_prompt' is not defined\n",
      "Processing batch 15 (70 to 75)\n",
      "Error processing 'Direct Credit Seek Limited Pay - xxxxxxxxxxxxxx0000': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx1597|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1298|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1514|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1433|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Sample result - 'Direct Credit Seek Limited Pay - xxxxxxxxxxxxxx0000': Error, name 'few_shot_prompt' is not defined\n",
      "Processing batch 16 (75 to 80)\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx8335|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx2001|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx3113|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1514|': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Bonus interest activated': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Sample result - 'Transfer\\\\nxxxx1085|xxxxx8335|SAV': Error, name 'few_shot_prompt' is not defined\n",
      "Processing batch 17 (80 to 85)\n",
      "Error processing 'Transfer\\\\nxxxx1433|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1611|xxxxx2598|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Bonus interest activated': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Interest earned': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Direct Credit SEEK LIMITED - xxxx2842': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Sample result - 'Transfer\\\\nxxxx1433|||SAV': Error, name 'few_shot_prompt' is not defined\n",
      "Processing batch 18 (85 to 90)\n",
      "Error processing 'Transfer\\\\nxxxx1298|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1433|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx6848|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Payment to American Express Australi': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1514|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Sample result - 'Transfer\\\\nxxxx1298|||SAV': Error, name 'few_shot_prompt' is not defined\n",
      "Processing batch 19 (90 to 95)\n",
      "Error processing 'Transfer\\\\nxxxx1298|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1298|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1298|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Bonus interest activated ($17.13)': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx8353|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Sample result - 'Transfer\\\\nxxxx1298|||SAV': Error, name 'few_shot_prompt' is not defined\n",
      "Processing batch 20 (95 to 99)\n",
      "Error processing 'Transfer\\\\nxxxx1298|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1433|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1085|xxxxx0135|SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Error processing 'Transfer\\\\nxxxx1514|||SAV': name 'few_shot_prompt' is not defined\n",
      "Response was: No response\n",
      "Sample result - 'Transfer\\\\nxxxx1298|||SAV': Error, name 'few_shot_prompt' is not defined\n",
      "\n",
      "Final Results:\n",
      "                           description category  \\\n",
      "0  Increase account balance by 1.0 AUD    Error   \n",
      "1                       Amazon Digital    Error   \n",
      "2             Bonus interest activated    Error   \n",
      "3             Bonus interest activated    Error   \n",
      "4                      Interest earned    Error   \n",
      "5    Bonus interest activated ($72.91)    Error   \n",
      "6             Bonus interest activated    Error   \n",
      "7             Bonus interest activated    Error   \n",
      "8             Bonus interest activated    Error   \n",
      "9             Bonus interest activated    Error   \n",
      "\n",
      "                             subcategory  \n",
      "0  name 'few_shot_prompt' is not defined  \n",
      "1  name 'few_shot_prompt' is not defined  \n",
      "2  name 'few_shot_prompt' is not defined  \n",
      "3  name 'few_shot_prompt' is not defined  \n",
      "4  name 'few_shot_prompt' is not defined  \n",
      "5  name 'few_shot_prompt' is not defined  \n",
      "6  name 'few_shot_prompt' is not defined  \n",
      "7  name 'few_shot_prompt' is not defined  \n",
      "8  name 'few_shot_prompt' is not defined  \n",
      "9  name 'few_shot_prompt' is not defined  \n"
     ]
    }
   ],
   "source": [
    "# 1. First, properly load the CSV file\n",
    "file_path = \"/kaggle/input/finance-test/transactions_20250104_test.csv\"\n",
    "import pandas as pd\n",
    "import json\n",
    "df = pd.read_csv(file_path)\n",
    "\n",
    "# 2. Define a function to process transactions in batches\n",
    "def process_transactions_in_batches(descriptions, batch_size=10):\n",
    "    all_categories = []\n",
    "    all_subcategories = []\n",
    "    \n",
    "    # Process in batches\n",
    "    for i in range(0, len(descriptions), batch_size):\n",
    "        batch = descriptions[i:i+batch_size]\n",
    "        batch_categories = []\n",
    "        batch_subcategories = []\n",
    "        \n",
    "        print(f\"Processing batch {i//batch_size + 1} ({i} to {min(i+batch_size, len(descriptions))})\")\n",
    "        \n",
    "        # Process each transaction in the current batch\n",
    "        for description in batch:\n",
    "            try:\n",
    "                response = client.models.generate_content(\n",
    "                    model='gemini-2.0-flash',\n",
    "                    config=types.GenerateContentConfig(\n",
    "                        temperature=0.1,\n",
    "                        top_p=1,\n",
    "                        max_output_tokens=250,\n",
    "                    ),\n",
    "                    contents=[{\"text\": few_shot_prompt}, {\"text\": description}]\n",
    "                )\n",
    "                \n",
    "                # Extract category and subcategory from the JSON response\n",
    "                response_text = response.text\n",
    "                # Find JSON object using braces\n",
    "                json_start = response_text.find('{')\n",
    "                json_end = response_text.rfind('}') + 1\n",
    "                \n",
    "                if json_start >= 0 and json_end > json_start:\n",
    "                    json_str = response_text[json_start:json_end]\n",
    "                    result = json.loads(json_str)\n",
    "                    category = result.get('category', 'Unknown')\n",
    "                    subcategory = result.get('subcategory', 'Unknown')\n",
    "                else:\n",
    "                    category = 'Error'\n",
    "                    subcategory = 'Could not parse response'\n",
    "                    \n",
    "            except Exception as e:\n",
    "                print(f\"Error processing '{description}': {e}\")\n",
    "                print(f\"Response was: {response.text if 'response' in locals() else 'No response'}\")\n",
    "                category = 'Error'\n",
    "                subcategory = str(e)\n",
    "            \n",
    "            batch_categories.append(category)\n",
    "            batch_subcategories.append(subcategory)\n",
    "        \n",
    "        # Add batch results to overall results\n",
    "        all_categories.extend(batch_categories)\n",
    "        all_subcategories.extend(batch_subcategories)\n",
    "        \n",
    "        # Optional: Display progress for each batch\n",
    "        if len(batch) > 0:\n",
    "            print(f\"Sample result - '{batch[0]}': {batch_categories[0]}, {batch_subcategories[0]}\")\n",
    "    \n",
    "    return all_categories, all_subcategories\n",
    "\n",
    "# 3. Execute the batch processing function\n",
    "categories, subcategories = process_transactions_in_batches(df['description'].tolist(), batch_size=5)\n",
    "\n",
    "# 4. Add the results to your dataframe\n",
    "df['category'] = categories\n",
    "df['subcategory'] = subcategories\n",
    "\n",
    "# 5. Display the first few results\n",
    "print(\"\\nFinal Results:\")\n",
    "print(df[['description', 'category', 'subcategory']].head(10))"
   ]
  }
 ],
 "metadata": {
  "kaggle": {
   "accelerator": "none",
   "dataSources": [
    {
     "datasetId": 7084116,
     "sourceId": 11325548,
     "sourceType": "datasetVersion"
    }
   ],
   "dockerImageVersionId": 30918,
   "isGpuEnabled": false,
   "isInternetEnabled": true,
   "language": "python",
   "sourceType": "notebook"
  },
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.10.12"
  },
  "papermill": {
   "default_parameters": {},
   "duration": 15.302227,
   "end_time": "2025-04-08T13:07:21.565743",
   "environment_variables": {},
   "exception": null,
   "input_path": "__notebook__.ipynb",
   "output_path": "__notebook__.ipynb",
   "parameters": {},
   "start_time": "2025-04-08T13:07:06.263516",
   "version": "2.6.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
